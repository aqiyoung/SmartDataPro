version: '3.8'

services:
  # 后端服务 - FastAPI应用
  backend:
    # 使用GitHub Container Registry上的镜像
    image: ghcr.io/aqiyoung/docmagic-backend:latest
    
    # 容器名称
    container_name: docmagic-backend
    
    # 端口映射：主机端口:容器端口
    ports:
      - "8016:8016"
    
    # 环境变量配置
    environment:
      - PYTHONUNBUFFERED=1  # 禁用Python缓冲输出，便于查看日志
      - TESSDATA_PREFIX=/usr/share/tesseract-ocr/5/tessdata/  # Tesseract OCR数据目录
      - DEBUG=1  # 开启调试模式，便于排查问题
    
    # 卷挂载：将主机目录挂载到容器
    volumes:
      - ./tmp:/tmp  # 临时文件目录，使用当前目录下的tmp文件夹
      - ./backend/logs:/app/logs  # 日志文件目录
      - ./backend/data:/app/data  # 数据文件目录
    
    # 健康检查配置 - 更严格的检查，确保后端完全可用
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8016/api/"]
      interval: 10s  # 更频繁的检查
      timeout: 5s    # 更短的超时
      retries: 5     # 更多重试次数
      start_period: 120s  # 更长的启动等待时间，确保依赖服务完全启动
    
    # 网络配置
    networks:
      - docmagic-network
    
    # 重启策略：除非手动停止，否则自动重启
    restart: unless-stopped

  # 前端服务 - Nginx应用
  frontend:
    # 使用GitHub Container Registry上的镜像
    image: ghcr.io/aqiyoung/docmagic-frontend:latest
    
    # 容器名称
    container_name: docmagic-frontend
    
    # 端口映射：主机端口:容器端口
    ports:
      - "5180:80"
    
    # 依赖关系：确保backend服务完全健康后再启动
    depends_on:
      backend:
        condition: service_healthy  # 只有当backend健康检查通过后才启动
    
    # 卷挂载：将主机目录挂载到容器
    volumes:
      # - ./frontend/dist:/usr/share/nginx/html  # 已移除：使用镜像内置的静态文件，避免本地空目录覆盖
      - ./frontend/logs:/var/log/nginx  # Nginx日志目录
    
    # 健康检查配置
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 60s  # 更长的启动等待时间
    
    # 网络配置
    networks:
      - docmagic-network
    
    # 重启策略：除非手动停止，否则自动重启
    restart: unless-stopped

# 网络配置
networks:
  docmagic-network:
    driver: bridge
    name: docmagic-network
    # 启用IPv6支持（可选）
    enable_ipv6: false