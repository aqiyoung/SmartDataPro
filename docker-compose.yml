services:
  # 后端服务 - FastAPI应用
  backend:
    # 使用GitHub Container Registry上的镜像
    image: ghcr.io/aqiyoung/smartdatapro-backend:v2.2.2
    
    # 容器名称
    container_name: smartdatapro-backend
    
    # 端口映射：主机端口:容器端口
    ports:
      - "8016:8016"
    
    # 环境变量配置
    environment:
      - PYTHONUNBUFFERED=1  # 禁用Python缓冲输出，便于查看日志
      - TESSDATA_PREFIX=/usr/share/tesseract-ocr/5/tessdata/  # Tesseract OCR数据目录
      - DEBUG=1  # 开启调试模式，便于排查问题
    
    # 卷挂载：将主机目录挂载到容器
    volumes:
      - ./tmp:/tmp  # 临时文件目录，使用当前目录下的tmp文件夹
      - ./backend/logs:/app/logs  # 日志文件目录
      - ./backend/data:/app/data  # 数据文件目录
    
    # 健康检查配置 - 调整为更宽松的检查，确保后端能正常启动
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; response = requests.get('http://localhost:8016/'); exit(0 if response.status_code < 500 else 1)"]
      interval: 30s  # 降低检查频率，给予更多恢复时间
      timeout: 20s   # 增加超时时间
      retries: 10     # 增加重试次数
      start_period: 300s  # 进一步增加启动等待时间
    
    # 网络配置
    networks:
      - smartdatapro-network
    
    # 重启策略：除非手动停止，否则自动重启
    restart: unless-stopped

  # 前端服务 - Nginx应用
  frontend:
    # 使用GitHub Container Registry上的镜像
    image: ghcr.io/aqiyoung/smartdatapro-frontend:v2.2.2
    
    # 容器名称
    container_name: smartdatapro-frontend
    
    # 端口映射：主机端口:容器端口
    ports:
      - "5180:80"
    
    # 依赖关系：确保backend服务启动后再启动
    depends_on:
      - backend
    
    # 卷挂载：将主机目录挂载到容器
    volumes:
      # - ./frontend/dist:/usr/share/nginx/html  # 已移除：使用镜像内置的静态文件，避免本地空目录覆盖
      - ./frontend/logs:/var/log/nginx  # Nginx日志目录
    
    # 健康检查配置
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 90s  # 更长的启动等待时间
    
    # 网络配置
    networks:
      - smartdatapro-network
    
    # 重启策略：除非手动停止，否则自动重启
    restart: unless-stopped

# 网络配置
networks:
  smartdatapro-network:
    driver: bridge
    name: smartdatapro-network
    # 启用IPv6支持（可选）
    enable_ipv6: false